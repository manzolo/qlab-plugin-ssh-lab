# ssh-lab — SSH Hardening & Security Lab

[![QLab Plugin](https://img.shields.io/badge/QLab-Plugin-blue)](https://github.com/manzolo/qlab)
[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/Platform-Linux-lightgrey)](https://github.com/manzolo/qlab)

A [QLab](https://github.com/manzolo/qlab) plugin that boots two virtual machines for hands-on SSH hardening practice: a **server** to defend (fail2ban, knockd, key authentication) and a **client** to attack from (nmap, hydra, sshpass).

## Architecture

```
┌─────────────────────────┐       ┌─────────────────────────┐
│    ssh-lab-server        │       │    ssh-lab-client        │
│    (Defender)            │       │    (Attacker)            │
│                          │       │                          │
│  sshd, fail2ban, knockd  │◄──────│  nmap, hydra, sshpass    │
│  iptables, rsyslog       │ SSH   │  knock, curl             │
│                          │       │                          │
│  SSH port: 2234          │       │  SSH port: 2235          │
└──────────┬───────────────┘       └──────────┬───────────────┘
           │                                  │
           └──────────┬───────────────────────┘
                      │ host (10.0.2.2)
                ┌─────┴─────┐
                │   QEMU    │
                │   Host    │
                └───────────┘
```

The client VM reaches the server through the host at `10.0.2.2:2234`. Both VMs share the same base cloud image via overlay disks.

## Credentials

- **Username:** `labuser`
- **Password:** `labpass`

## Ports

| VM              | Host Port | VM Port | Service     |
|-----------------|-----------|---------|-------------|
| ssh-lab-server  | 2234      | 22      | SSH (sshd)  |
| ssh-lab-client  | 2235      | 22      | SSH (shell) |

## Usage

```bash
# Install the plugin
qlab install ssh-lab

# Run the lab (boots both VMs)
qlab run ssh-lab

# Wait ~90s for boot and package installation, then:

# Connect to the server (defender)
qlab shell ssh-lab-server

# Connect to the client (attacker)
qlab shell ssh-lab-client

# View boot logs
qlab log ssh-lab-server
qlab log ssh-lab-client

# Stop both VMs
qlab stop ssh-lab

# Stop a single VM
qlab stop ssh-lab-server
qlab stop ssh-lab-client
```

## Exercises

### 1. SSH Key Authentication

Learn how public key authentication works and why it's safer than passwords.

**From the client VM** (`qlab shell ssh-lab-client`):

```bash
# Connect to the server using password authentication
sshpass -p labpass ssh labuser@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no
```

**On the server VM** (`qlab shell ssh-lab-server`):

```bash
# Examine the authorized_keys file — it contains both the qlab key and the ed25519 key
cat ~/.ssh/authorized_keys

# Look at the key pair generated by cloud-init
ls -la ~/.ssh/

# Disable password authentication (key-only access)
sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo systemctl restart sshd
```

**Verify from client:**

```bash
# Password login should now fail
sshpass -p labpass ssh labuser@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no
# → Permission denied

# But qlab shell still works (uses key-based auth)
# Disconnect and reconnect via: qlab shell ssh-lab-server
```

---

### 2. fail2ban Brute-Force Protection

Understand how fail2ban monitors auth logs and bans repeat offenders.

> **Note:** Ban time is set to 60 seconds so that if you get locked out (both
> `qlab shell` and client connections share the same IP in QEMU), just wait
> 1 minute or unban from the server.

**On the server VM:**

```bash
# Check fail2ban status
sudo fail2ban-client status sshd

# Watch the auth log in real time (keep this terminal open)
sudo tail -f /var/log/auth.log
```

**From the client VM** (in a new terminal):

```bash
# Trigger 3+ failed login attempts to get banned
sshpass -p wrong ssh labuser@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no
sshpass -p wrong ssh labuser@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no
sshpass -p wrong ssh labuser@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no
sshpass -p wrong ssh labuser@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no
```

**Back on the server VM:**

```bash
# Check if the IP was banned
sudo fail2ban-client status sshd

# View failed attempts in auth.log
sudo grep "Failed password" /var/log/auth.log

# View the ban in fail2ban log
sudo grep "Ban" /var/log/fail2ban.log

# Unban the IP immediately (replace <IP> with the banned address)
sudo fail2ban-client set sshd unbanip <IP>

# Or just wait 60 seconds — the ban expires automatically
```

---

### 3. Port Knocking with knockd

Learn how to hide SSH behind a knock sequence so port scans don't reveal it.

**On the server VM:**

```bash
# Review the knockd configuration
cat /etc/knockd.conf
# The open sequence is: 7000, 8000, 9000
# The close sequence is: 9000, 8000, 7000

# Add an iptables rule to DROP SSH by default
sudo iptables -A INPUT -p tcp --dport 22 -j DROP

# Verify SSH is now blocked
sudo iptables -L -n
```

**From the client VM:**

```bash
# Verify SSH is blocked
nmap -p 22 10.0.2.2
# → Port 22 is filtered

# Knock the open sequence
knock 10.0.2.2 7000 8000 9000

# Wait a second, then verify SSH is now accessible
sleep 1
nmap -p 22 10.0.2.2
# → Port 22 is open

# Connect to the server
ssh labuser@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no

# After disconnecting, close with the reverse sequence
knock 10.0.2.2 9000 8000 7000
```

---

### 4. SSH Daemon Hardening

Practice applying security best practices to sshd_config.

**On the server VM:**

```bash
# View the current SSH configuration
sudo cat /etc/ssh/sshd_config

# Apply hardening settings
sudo tee -a /etc/ssh/sshd_config.d/hardening.conf > /dev/null <<EOF
PermitRootLogin no
PasswordAuthentication no
MaxAuthTries 2
PubkeyAuthentication yes
X11Forwarding no
EOF

# Restart SSH to apply changes
sudo systemctl restart sshd
```

**Verify from client:**

```bash
# Root login should be denied
sshpass -p labpass ssh root@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no
# → Permission denied

# Password auth should be denied
sshpass -p labpass ssh labuser@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no
# → Permission denied

# After 2 failed attempts, the connection should be dropped
```

---

### 5. Log Analysis

Learn to read and interpret SSH authentication logs.

**On the server VM:**

```bash
# Monitor the auth log in real time
sudo tail -f /var/log/auth.log
```

**From the client VM** (generate traffic):

```bash
# Successful login (with password, if still enabled)
sshpass -p labpass ssh labuser@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no "echo connected" 2>/dev/null

# Failed login (wrong password)
sshpass -p wrong ssh labuser@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no 2>/dev/null

# Failed login (nonexistent user)
sshpass -p test ssh nobody@10.0.2.2 -p 2234 -o StrictHostKeyChecking=no 2>/dev/null
```

**Back on the server VM:**

```bash
# Search for failed attempts
sudo grep "Failed password" /var/log/auth.log

# Search for successful logins
sudo grep "Accepted" /var/log/auth.log

# Check what fail2ban sees
sudo fail2ban-client status sshd
```

## Resetting

To start fresh, stop and re-run:

```bash
qlab stop ssh-lab
qlab run ssh-lab
```

Or reset the entire workspace:

```bash
qlab reset
```
